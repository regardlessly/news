<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Today's News ‚Äî Easy Read</title>
  <style>
    /* ---- Brand: Modern B2B SaaS ---- */
    :root {
      --primary:    #1155cc;
      --light-blue: #cfe2f3;
      --bg:         #efefef;
      --surface:    #ffffff;
      --border:     #d8e4f0;
      --text:       #000000;
      --muted:      #555;
      --radius:     14px;
      --font:       "Helvetica Neue", Helvetica, Arial, sans-serif;
    }
    body.dark {
      --bg:      #1a1e26;
      --surface: #232a35;
      --border:  #2e3b4e;
      --text:    #e8edf5;
      --muted:   #8fa4be;
      --light-blue: #1e3a5f;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      font-size: 16px;
      line-height: 1.7;
    }

    /* ---- Header ---- */
    .header {
      background: var(--surface);
      border-bottom: 2px solid var(--border);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(17,85,204,.08);
    }
    .header-left { display: flex; align-items: center; gap: 14px; flex-wrap: wrap; }
    .logo {
      font-size: 1.25rem;
      font-weight: bold;
      color: var(--primary);
      letter-spacing: -0.3px;
    }
    .tagline { font-size: 0.85rem; color: var(--muted); }
    .header-right { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .btn {
      padding: 7px 16px;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: bold;
      font-family: var(--font);
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: opacity 0.15s;
    }
    .btn:hover { opacity: 0.85; }
    .btn-back  { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
    .btn-chat  { background: var(--primary); color: #fff; }
    .btn-theme {
      background: var(--surface);
      border: 1px solid var(--border);
      width: 36px; height: 36px;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
    }

    /* ---- Greeting ---- */
    .greeting {
      max-width: 800px;
      margin: 32px auto 20px;
      padding: 0 24px;
    }
    .date-badge {
      display: inline-block;
      background: var(--primary);
      color: #fff;
      padding: 4px 14px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: bold;
      letter-spacing: 0.3px;
      margin-bottom: 12px;
    }
    .greeting h1 {
      font-size: 1.75rem;
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 8px;
      line-height: 1.3;
    }
    .greeting p {
      font-size: 0.95rem;
      color: var(--muted);
    }

    /* ---- Container ---- */
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 0 24px 60px;
    }

    /* ---- Section card ---- */
    .section-block {
      margin-bottom: 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px 28px;
      box-shadow: 0 1px 4px rgba(17,85,204,.06);
    }
    .section-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--light-blue);
    }
    .section-icon { font-size: 1.4rem; }
    .section-header h2 {
      font-size: 1.1rem;
      font-weight: bold;
      flex: 1;
      color: var(--primary);
    }
    .article-count {
      font-size: 0.75rem;
      color: var(--muted);
      background: var(--bg);
      border: 1px solid var(--border);
      padding: 2px 10px;
      border-radius: 10px;
      font-weight: bold;
    }

    /* ---- Summary text (readable, slightly larger) ---- */
    .section-summary {
      font-size: 1.0rem;
      line-height: 1.8;
      color: var(--text);
      margin-bottom: 16px;
    }
    .section-summary p { margin-bottom: 10px; }
    .section-summary p:last-child { margin-bottom: 0; }

    /* Bullet list with visible disc markers */
    .summary-bullets {
      list-style: disc;
      margin: 8px 0 10px 1.4em;
      padding: 0;
    }
    .summary-bullets li {
      margin-bottom: 6px;
      line-height: 1.75;
    }
    .summary-bullets li::marker { color: var(--primary); }

    /* ---- Collapsible sources ---- */
    .sources-details {
      margin-top: 4px;
    }
    .sources-details summary.sources-toggle {
      font-size: 0.8rem;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--primary);
      cursor: pointer;
      user-select: none;
      list-style: none;            /* hide browser default ‚ñ∂ */
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 0;
      margin-bottom: 4px;
    }
    .sources-details summary.sources-toggle::before {
      content: '‚ñ∂';
      font-size: 0.65rem;
      transition: transform 0.2s;
      display: inline-block;
    }
    .sources-details[open] summary.sources-toggle::before {
      transform: rotate(90deg);
    }
    .sources-details summary.sources-toggle::-webkit-details-marker { display: none; }
    .sources-list {
      list-style: none;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .sources-list li a {
      font-size: 0.8rem;
      font-family: var(--font);
      color: var(--primary);
      text-decoration: none;
      background: var(--light-blue);
      border: 1px solid var(--border);
      padding: 3px 10px;
      border-radius: 6px;
      display: inline-block;
      transition: background 0.15s, color 0.15s;
    }
    .sources-list li a:hover {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    /* ---- Loading / empty ---- */
    .loading {
      text-align: center;
      padding: 80px 20px;
      color: var(--muted);
      font-size: 1rem;
    }
    .spinner {
      width: 40px; height: 40px;
      border: 4px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ---- Footer ---- */
    .footer {
      text-align: center;
      padding: 20px 24px;
      color: var(--muted);
      font-size: 0.8rem;
      border-top: 1px solid var(--border);
    }
    .footer a { color: var(--primary); text-decoration: none; }

    /* ---- Responsive ---- */
    @media (max-width: 600px) {
      body { font-size: 15px; }
      .greeting h1 { font-size: 1.45rem; }
      .header { padding: 12px 16px; }
      .greeting, .container { padding-left: 16px; padding-right: 16px; }
      .section-block { padding: 18px 16px; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <span class="logo">üì∞ CNA Digest</span>
      <span class="tagline">Easy Read Edition</span>
    </div>
    <div class="header-right">
      <a href="/" class="btn btn-back">‚Üê Full View</a>
      <a href="/chat" class="btn btn-chat">üí¨ Ask Questions</a>
      <button class="btn-theme" id="themeToggle" title="Toggle theme">üåô</button>
    </div>
  </header>

  <div class="greeting">
    <div class="date-badge" id="dateBadge">Today</div>
    <h1>Good morning! Here's what's happening today.</h1>
    <p id="digestIntro">Loading today's news for you...</p>
  </div>

  <div class="container">
    <div id="digestContent">
      <div class="loading">
        <div class="spinner"></div>
        <p>Fetching today's news...</p>
      </div>
    </div>
  </div>

  <footer class="footer">
    <p>News from Channel NewsAsia ¬∑ Summaries generated by AI ¬∑ <a href="/">See all articles</a></p>
  </footer>

  <script>
    // ---- Theme ----
    (function () {
      const saved = localStorage.getItem('digest_theme') || 'light';
      if (saved === 'dark') {
        document.body.classList.add('dark');
        document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
      }
    })();
    document.getElementById('themeToggle').addEventListener('click', () => {
      document.body.classList.toggle('dark');
      const isDark = document.body.classList.contains('dark');
      localStorage.setItem('digest_theme', isDark ? 'dark' : 'light');
      document.getElementById('themeToggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    });

    // ---- Helpers ----
    function todayString() {
      return new Date().toLocaleDateString('en-SG', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });
    }

    function escapeHtml(str) {
      return (str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    // Convert **bold** markdown to <strong> after HTML-escaping
    function formatInline(str) {
      return escapeHtml(str)
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    }

    // ---- Render markdown summary as HTML ----
    function renderSummaryHtml(text) {
      const lines = text.split('\n');
      let html = '';
      let inList = false;
      for (const line of lines) {
        const trimmed = line.trim();
        const isBullet = trimmed.startsWith('- ') || trimmed.startsWith('‚Ä¢ ') || trimmed.startsWith('* ');
        if (isBullet) {
          if (!inList) { html += '<ul class="summary-bullets">'; inList = true; }
          html += `<li>${formatInline(trimmed.slice(2))}</li>`;
        } else {
          if (inList) { html += '</ul>'; inList = false; }
          if (trimmed) html += `<p>${formatInline(trimmed)}</p>`;
        }
      }
      if (inList) html += '</ul>';
      return html || `<p>${formatInline(text)}</p>`;
    }

    function renderGroup(group) {
      const summary  = group.summary || 'No summary available.';
      const articles = group.articles || [];

      const sourceLinks = articles.map(a =>
        `<li><a href="${a.url}" target="_blank" rel="noopener">${escapeHtml(a.title)}</a></li>`
      ).join('');

      const sourcesBlock = articles.length ? `
        <details class="sources-details">
          <summary class="sources-toggle">Read the full stories (${articles.length})</summary>
          <ul class="sources-list">${sourceLinks}</ul>
        </details>` : '';

      return `
        <div class="section-block">
          <div class="section-header">
            <span class="section-icon">${group.icon}</span>
            <h2>${escapeHtml(group.label)} News</h2>
            <span class="article-count">${group.article_count} stories</span>
          </div>
          <div class="section-summary">${renderSummaryHtml(summary)}</div>
          ${sourcesBlock}
        </div>`;
    }

    function renderDigest(data) {
      document.getElementById('dateBadge').textContent = todayString();
      const intro   = document.getElementById('digestIntro');
      const content = document.getElementById('digestContent');

      if (!data.groups || data.groups.length === 0) {
        intro.textContent = 'No news articles found yet. Please check back later.';
        content.innerHTML = '<div class="loading"><p>No articles found for today.</p></div>';
        return;
      }

      intro.textContent = "Here is today's news, picked especially for you.";
      content.innerHTML = data.groups.map(renderGroup).join('');
    }

    function showBuilding(sectionsLeft) {
      const content = document.getElementById('digestContent');
      const intro   = document.getElementById('digestIntro');
      intro.textContent = 'Preparing your personalised digest ‚Äî this takes about a minute on first load‚Ä¶';
      const msg = sectionsLeft > 0
        ? `Summarising sections‚Ä¶ (${sectionsLeft} remaining)`
        : "Fetching today's news‚Ä¶";
      content.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>${msg}</p>
        </div>`;
    }

    // ---- Fetch with polling ----
    let _pollTimer = null;

    async function loadDigest() {
      try {
        const statusResp = await fetch('/api/digest-status');
        const status = await statusResp.json();

        if (status.ready) {
          clearTimeout(_pollTimer);
          const resp = await fetch('/api/digest-summary?days=1');
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          renderDigest(await resp.json());
        } else {
          const sectionsLeft = 5 - (status.sections || 0);
          showBuilding(sectionsLeft);
          _pollTimer = setTimeout(loadDigest, 3000);
        }
      } catch (e) {
        clearTimeout(_pollTimer);
        document.getElementById('digestContent').innerHTML =
          '<div class="loading"><p>Could not load news. Please try refreshing the page.</p></div>';
        document.getElementById('digestIntro').textContent = '';
      }
    }

    document.addEventListener('DOMContentLoaded', loadDigest);
  </script>
</body>
</html>
